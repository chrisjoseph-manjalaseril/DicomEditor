<Window x:Class="DicomEditor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:DicomEditor"
        xmlns:vm="clr-namespace:DicomEditor.ViewModels"
        mc:Ignorable="d"
        Title="{Binding Title}" 
        Height="800" Width="1200"
        MinHeight="600" MinWidth="900"
        WindowStartupLocation="CenterScreen"
        AllowDrop="True"
        Drop="Window_Drop"
        DragOver="Window_DragOver"
        d:DataContext="{d:DesignInstance Type=vm:MainViewModel, IsDesignTimeCreatable=False}">

    <Window.Resources>
        <!-- Boolean to Visibility Converter -->
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>
        
        <!-- Inverse Boolean to Visibility Converter -->
        <local:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVisConverter"/>

        <!-- Animated Spinner Style -->
        <Style x:Key="SpinnerStyle" TargetType="Border">
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="CornerRadius" Value="20"/>
            <Setter Property="BorderThickness" Value="4"/>
            <Setter Property="BorderBrush" Value="#E0E0E0"/>
            <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <RotateTransform Angle="0"/>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Progress Bar Style -->
        <Style x:Key="LoadingProgressBarStyle" TargetType="ProgressBar">
            <Setter Property="Height" Value="24"/>
            <Setter Property="Background" Value="#E8E8E8"/>
            <Setter Property="Foreground" Value="#0078D4"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>

        <!-- Loading Panel Animation -->
        <Storyboard x:Key="SpinnerAnimation" RepeatBehavior="Forever">
            <DoubleAnimation Storyboard.TargetName="SpinnerArc"
                             Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                             From="0" To="360" Duration="0:0:1"/>
        </Storyboard>

        <!-- Fade In Animation for Loading Overlay -->
        <Storyboard x:Key="FadeInAnimation">
            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                             From="0" To="1" Duration="0:0:0.2"/>
        </Storyboard>
    </Window.Resources>

    <Window.Triggers>
        <EventTrigger RoutedEvent="Window.Loaded">
            <BeginStoryboard Storyboard="{StaticResource SpinnerAnimation}"/>
        </EventTrigger>
    </Window.Triggers>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Menu -->
            <RowDefinition Height="Auto"/>  <!-- Toolbar -->
            <RowDefinition Height="*"/>     <!-- Main Content -->
            <RowDefinition Height="Auto"/>  <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- Menu Bar -->
        <Menu Grid.Row="0">
            <MenuItem Header="_File">
                <MenuItem Header="_Open Files..." Command="{Binding OpenFilesCommand}" InputGestureText="Ctrl+O">
                    <MenuItem.Icon>
                        <TextBlock Text="📂" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Open _Folder..." Command="{Binding OpenFolderCommand}" InputGestureText="Ctrl+Shift+O">
                    <MenuItem.Icon>
                        <TextBlock Text="📁" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <Separator/>
                <MenuItem Header="_Save" Command="{Binding SaveSelectedFileCommand}" InputGestureText="Ctrl+S">
                    <MenuItem.Icon>
                        <TextBlock Text="💾" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Save _All Modified" Command="{Binding SaveAllModifiedCommand}" InputGestureText="Ctrl+Shift+S"/>
                <Separator/>
                <MenuItem Header="E_xit" Click="MenuItem_Exit_Click"/>
            </MenuItem>
            <MenuItem Header="_Edit">
                <MenuItem Header="_Undo" Command="{Binding UndoCommand}" InputGestureText="Ctrl+Z">
                    <MenuItem.Icon>
                        <TextBlock Text="↩" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="_Redo" Command="{Binding RedoCommand}" InputGestureText="Ctrl+Y">
                    <MenuItem.Icon>
                        <TextBlock Text="↪" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <Separator/>
                <MenuItem Header="_Edit Tag Value" Command="{Binding EditTagCommand}" InputGestureText="F2"/>
                <MenuItem Header="_Copy Tag" Command="{Binding CopyTagCommand}" InputGestureText="Ctrl+C"/>
                <MenuItem Header="_Delete Tag" Command="{Binding DeleteTagCommand}" InputGestureText="Del"/>
                <Separator/>
                <MenuItem Header="Apply Value to _All Files..." Command="{Binding BulkUpdateTagCommand}" InputGestureText="Ctrl+Shift+A">
                    <MenuItem.Icon>
                        <TextBlock Text="📋" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Delete Tag from All _Files..." Command="{Binding BulkDeleteTagCommand}" InputGestureText="Ctrl+Shift+D">
                    <MenuItem.Icon>
                        <TextBlock Text="🗑️" FontSize="14"/>
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>
            <MenuItem Header="_View">
                <MenuItem Header="_Refresh" Command="{Binding RefreshCommand}" InputGestureText="F5"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_About" Click="MenuItem_About_Click"/>
            </MenuItem>
        </Menu>

        <!-- Toolbar -->
        <ToolBarTray Grid.Row="1">
            <ToolBar>
                <Button Command="{Binding OpenFilesCommand}" ToolTip="Open Files (Ctrl+O)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="📂" FontSize="16" Margin="0,0,4,0"/>
                        <TextBlock Text="Open Files"/>
                    </StackPanel>
                </Button>
                <Button Command="{Binding OpenFolderCommand}" ToolTip="Open Folder (Ctrl+Shift+O)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="📁" FontSize="16" Margin="0,0,4,0"/>
                        <TextBlock Text="Open Folder"/>
                    </StackPanel>
                </Button>
                <Separator/>
                <Button Command="{Binding SaveSelectedFileCommand}" ToolTip="Save Selected File (Ctrl+S)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="💾" FontSize="16" Margin="0,0,4,0"/>
                        <TextBlock Text="Save"/>
                    </StackPanel>
                </Button>
                <Button Command="{Binding SaveAllModifiedCommand}" ToolTip="Save All Modified (Ctrl+Shift+S)">
                    <TextBlock Text="Save All"/>
                </Button>
                <Separator/>
                <Button Command="{Binding UndoCommand}" ToolTip="{Binding UndoDescription}">
                    <TextBlock Text="↩ Undo" FontSize="14"/>
                </Button>
                <Button Command="{Binding RedoCommand}" ToolTip="{Binding RedoDescription}">
                    <TextBlock Text="↪ Redo" FontSize="14"/>
                </Button>
                <Separator/>
                <Button Command="{Binding BulkUpdateTagCommand}" ToolTip="Apply selected tag value to all files (Ctrl+Shift+A)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="📋" FontSize="16" Margin="0,0,4,0"/>
                        <TextBlock Text="Apply to All"/>
                    </StackPanel>
                </Button>
                <Separator/>
                <Button Command="{Binding CancelLoadingCommand}" 
                        Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisConverter}}"
                        ToolTip="Cancel Loading">
                    <TextBlock Text="⏹ Cancel" Foreground="Red"/>
                </Button>
            </ToolBar>
        </ToolBarTray>

        <!-- Main Content Area -->
        <Grid Grid.Row="2" Margin="4">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350" MinWidth="200"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*" MinWidth="400"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: File List -->
            <GroupBox Grid.Column="0" Header="DICOM Files" Margin="2">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- File Count - Fixed to show correct modified count -->
                    <TextBlock Grid.Row="0" Margin="4" FontWeight="SemiBold">
                        <Run Text="Files: "/>
                        <Run Text="{Binding Files.Count, Mode=OneWay}"/>
                        <Run Text=" | Modified: "/>
                        <Run Text="{Binding ModifiedFilesCount, Mode=OneWay}" Foreground="Orange"/>
                    </TextBlock>

                    <!-- Files DataGrid with Virtualization -->
                    <DataGrid Grid.Row="1" 
                              x:Name="FilesDataGrid"
                              ItemsSource="{Binding Files}"
                              SelectedItem="{Binding SelectedFile}"
                              EnableRowVirtualization="True"
                              EnableColumnVirtualization="True"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"
                              VirtualizingPanel.ScrollUnit="Pixel"
                              ScrollViewer.IsDeferredScrollingEnabled="True"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              SelectionMode="Single"
                              GridLinesVisibility="Horizontal"
                              AlternatingRowBackground="#F8F8F8"
                              HeadersVisibility="Column">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="File Name" Binding="{Binding FileName}" Width="*">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsModified}" Value="True">
                                                <Setter Property="FontWeight" Value="Bold"/>
                                                <Setter Property="Foreground" Value="Orange"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding HasErrors}" Value="True">
                                                <Setter Property="Foreground" Value="Red"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Patient" Binding="{Binding PatientName}" Width="100"/>
                            <DataGridTextColumn Header="Modality" Binding="{Binding Modality}" Width="60"/>
                        </DataGrid.Columns>
                        
                        <DataGrid.RowStyle>
                            <Style TargetType="DataGridRow">
                                <Setter Property="ToolTip" Value="{Binding FilePath}"/>
                            </Style>
                        </DataGrid.RowStyle>
                    </DataGrid>

                    <!-- File Info Panel -->
                    <Border Grid.Row="2" Background="#F0F0F0" Padding="4" 
                            Visibility="{Binding HasSelectedFile, Converter={StaticResource BoolToVisConverter}}">
                        <StackPanel>
                            <TextBlock Text="{Binding SelectedFile.PatientName}" FontWeight="Bold"/>
                            <TextBlock Text="{Binding SelectedFile.StudyDescription}" TextTrimming="CharacterEllipsis"/>
                            <TextBlock Text="{Binding SelectedFile.StudyDate}" Foreground="Gray"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </GroupBox>

            <!-- Splitter -->
            <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch"
                          Background="LightGray" Cursor="SizeWE"/>

            <!-- Right Panel: Tag Editor -->
            <GroupBox Grid.Column="2" Header="DICOM Tags" Margin="2">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Search Bar -->
                    <Grid Grid.Row="0" Margin="4">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBox Grid.Column="0" 
                                 Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                                 VerticalContentAlignment="Center"
                                 Padding="4">
                            <TextBox.Style>
                                <Style TargetType="TextBox">
                                    <Style.Triggers>
                                        <Trigger Property="Text" Value="">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <VisualBrush Stretch="None" AlignmentX="Left">
                                                        <VisualBrush.Visual>
                                                            <TextBlock Text="🔍 Search tags..." Foreground="Gray" Margin="4,0,0,0"/>
                                                        </VisualBrush.Visual>
                                                    </VisualBrush>
                                                </Setter.Value>
                                            </Setter>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBox.Style>
                        </TextBox>

                        <Button Grid.Column="1" Content="✕" Width="24" Margin="4,0,0,0"
                                Command="{Binding ClearSearchCommand}"
                                ToolTip="Clear Search"/>
                    </Grid>

                    <!-- Tags DataGrid with Virtualization and Inline Editing -->
                    <DataGrid Grid.Row="1" 
                              x:Name="TagsDataGrid"
                              ItemsSource="{Binding TagsView}"
                              SelectedItem="{Binding SelectedTag}"
                              IsReadOnly="False"
                              EnableRowVirtualization="True"
                              EnableColumnVirtualization="True"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"
                              VirtualizingPanel.ScrollUnit="Pixel"
                              ScrollViewer.IsDeferredScrollingEnabled="True"
                              AutoGenerateColumns="False"
                              SelectionMode="Single"
                              GridLinesVisibility="Horizontal"
                              AlternatingRowBackground="#F8F8F8"
                              HeadersVisibility="Column"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              BeginningEdit="TagsDataGrid_BeginningEdit"
                              CellEditEnding="TagsDataGrid_CellEditEnding">
                        <DataGrid.Columns>
                            <!-- Tag Column -->
                            <DataGridTextColumn Header="Tag" Binding="{Binding TagDisplay}" Width="100" IsReadOnly="True">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="FontFamily" Value="Consolas"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsPrivateTag}" Value="True">
                                                <Setter Property="Foreground" Value="#8B4513"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!-- VR Column -->
                            <DataGridTextColumn Header="VR" Binding="{Binding VR}" Width="45" IsReadOnly="True">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="FontFamily" Value="Consolas"/>
                                        <Setter Property="Foreground" Value="Gray"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!-- Name Column -->
                            <DataGridTextColumn Header="Name" Binding="{Binding TagName}" Width="200" IsReadOnly="True">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsPrivateTag}" Value="True">
                                                <Setter Property="FontStyle" Value="Italic"/>
                                                <Setter Property="Foreground" Value="#8B4513"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <!-- Value Column (Editable) -->
                            <DataGridTextColumn Header="Value" Width="*" IsReadOnly="False"
                                                Binding="{Binding ValueDisplay, Mode=TwoWay, UpdateSourceTrigger=LostFocus}">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                        <Setter Property="Padding" Value="4,2"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HasValidationError}" Value="True">
                                                <Setter Property="Foreground" Value="Red"/>
                                                <Setter Property="ToolTip" Value="{Binding ValidationErrorMessage}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsEditable}" Value="False">
                                                <Setter Property="Foreground" Value="Gray"/>
                                                <Setter Property="FontStyle" Value="Italic"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding HasEmptyValue}" Value="True">
                                                <Setter Property="Foreground" Value="LightGray"/>
                                                <Setter Property="FontStyle" Value="Italic"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                                <DataGridTextColumn.EditingElementStyle>
                                    <Style TargetType="TextBox">
                                        <Setter Property="BorderBrush" Value="#0078D4"/>
                                        <Setter Property="BorderThickness" Value="2"/>
                                        <Setter Property="Padding" Value="4,2"/>
                                        <Setter Property="Background" Value="#FFFFF0"/>
                                    </Style>
                                </DataGridTextColumn.EditingElementStyle>
                            </DataGridTextColumn>
                        </DataGrid.Columns>

                        <DataGrid.RowStyle>
                            <Style TargetType="DataGridRow">
                                <Setter Property="ToolTip">
                                    <Setter.Value>
                                        <StackPanel MaxWidth="400">
                                            <TextBlock Text="{Binding TagName}" FontWeight="Bold"/>
                                            <TextBlock Text="{Binding TagDisplay}" Foreground="Gray"/>
                                            <TextBlock Text="{Binding VR}" Foreground="Gray" FontFamily="Consolas"/>
                                            <TextBlock Text="{Binding ValueDisplay}" TextWrapping="Wrap" Margin="0,4,0,0"/>
                                            <TextBlock Text="{Binding PrivateCreator, StringFormat='Private Creator: {0}'}" 
                                                       Foreground="#8B4513" FontStyle="Italic" Margin="0,4,0,0"
                                                       Visibility="{Binding IsPrivateTag, Converter={StaticResource BoolToVisConverter}}"/>
                                            <TextBlock Text="(Double-click to edit)" Foreground="Blue" FontStyle="Italic" Margin="0,4,0,0"
                                                       Visibility="{Binding IsEditable, Converter={StaticResource BoolToVisConverter}}"/>
                                        </StackPanel>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsSequence}" Value="True">
                                        <Setter Property="Background" Value="#E8E8FF"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding IsPrivateTag}" Value="True">
                                        <Setter Property="Background" Value="#FFF8F0"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.RowStyle>

                        <!-- Context Menu for Tags -->
                        <DataGrid.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Edit Value" Command="{Binding EditTagCommand}" InputGestureText="F2"/>
                                <MenuItem Header="Copy" Command="{Binding CopyTagCommand}" InputGestureText="Ctrl+C"/>
                                <Separator/>
                                <MenuItem Header="Apply Value to All Files..." Command="{Binding BulkUpdateTagCommand}" InputGestureText="Ctrl+Shift+A">
                                    <MenuItem.Icon>
                                        <TextBlock Text="📋" FontSize="14"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Delete Tag from All Files..." Command="{Binding BulkDeleteTagCommand}" InputGestureText="Ctrl+Shift+D">
                                    <MenuItem.Icon>
                                        <TextBlock Text="🗑️" FontSize="14"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <Separator/>
                                <MenuItem Header="Delete Tag" Command="{Binding DeleteTagCommand}" InputGestureText="Del"/>
                            </ContextMenu>
                        </DataGrid.ContextMenu>
                    </DataGrid>

                    <!-- No File Selected Message -->
                    <TextBlock Grid.Row="1" 
                               Text="Select a file to view its DICOM tags"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Foreground="Gray"
                               FontSize="14"
                               Visibility="{Binding HasSelectedFile, Converter={StaticResource InverseBoolToVisConverter}}"/>
                </Grid>
            </GroupBox>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="3">
            <StatusBar.ItemsPanel>
                <ItemsPanelTemplate>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="200"/>
                        </Grid.ColumnDefinitions>
                    </Grid>
                </ItemsPanelTemplate>
            </StatusBar.ItemsPanel>

            <StatusBarItem Grid.Column="0">
                <TextBlock Text="{Binding StatusMessage}"/>
            </StatusBarItem>

            <StatusBarItem Grid.Column="1" 
                           Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisConverter}}">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="{Binding LoadingMessage}" Margin="0,0,8,0"/>
                    <TextBlock Text="{Binding LoadedFilesCount}"/>
                    <TextBlock Text=" / "/>
                    <TextBlock Text="{Binding TotalFilesCount}"/>
                </StackPanel>
            </StatusBarItem>

            <StatusBarItem Grid.Column="2">
                <ProgressBar Width="180" Height="16" 
                             Value="{Binding LoadProgress}" 
                             Maximum="100"
                             Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisConverter}}"/>
            </StatusBarItem>
        </StatusBar>

        <!-- Enhanced Loading Overlay with Animation -->
        <Border Grid.RowSpan="4" 
                x:Name="LoadingOverlay"
                Background="#90000000"
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisConverter}}">
            
            <Border.Style>
                <Style TargetType="Border">
                    <Style.Triggers>
                        <Trigger Property="Visibility" Value="Visible">
                            <Trigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                         From="0" To="1" Duration="0:0:0.2"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </Trigger.EnterActions>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <!-- Loading Dialog Box -->
            <Border Background="White" 
                    CornerRadius="12" 
                    Padding="32"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    MinWidth="400"
                    MaxWidth="500">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="20" ShadowDepth="4" Opacity="0.3"/>
                </Border.Effect>
                
                <StackPanel>
                    <!-- Animated Spinner -->
                    <Grid Width="60" Height="60" HorizontalAlignment="Center" Margin="0,0,0,20">
                        <!-- Background Circle -->
                        <Ellipse Width="60" Height="60" Stroke="#E8E8E8" StrokeThickness="6"/>
                        
                        <!-- Spinning Arc -->
                        <Border x:Name="SpinnerArc" 
                                Width="60" Height="60"
                                RenderTransformOrigin="0.5,0.5">
                            <Border.RenderTransform>
                                <RotateTransform Angle="0"/>
                            </Border.RenderTransform>
                            <Path Stroke="#0078D4" StrokeThickness="6" StrokeStartLineCap="Round" StrokeEndLineCap="Round">
                                <Path.Data>
                                    <PathGeometry>
                                        <PathFigure StartPoint="30,3">
                                            <ArcSegment Point="57,30" Size="27,27" SweepDirection="Clockwise"/>
                                        </PathFigure>
                                    </PathGeometry>
                                </Path.Data>
                            </Path>
                        </Border>
                    </Grid>

                    <!-- Loading Title -->
                    <TextBlock Text="{Binding LoadingMessage}" 
                               FontSize="18" 
                               FontWeight="SemiBold"
                               Foreground="#333333"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,8"/>

                    <!-- Loading Subtitle/Phase -->
                    <TextBlock Text="Please wait while files are being processed..."
                               FontSize="12"
                               Foreground="#666666"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,20"/>

                    <!-- Progress Bar with Percentage -->
                    <Grid Margin="0,0,0,8">
                        <ProgressBar Height="24" 
                                     Value="{Binding LoadProgress}" 
                                     Maximum="100"
                                     Style="{StaticResource LoadingProgressBarStyle}"/>
                        <TextBlock HorizontalAlignment="Center" 
                                   VerticalAlignment="Center"
                                   FontWeight="SemiBold"
                                   Foreground="#333333">
                            <Run Text="{Binding LoadProgress, StringFormat={}{0:F0}}"/>
                            <Run Text="%"/>
                        </TextBlock>
                    </Grid>

                    <!-- File Count -->
                    <Border Background="#F5F5F5" CornerRadius="6" Padding="16,10" Margin="0,8,0,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel Grid.Column="0" Orientation="Horizontal">
                                <TextBlock Text="📄 Files loaded: " Foreground="#666666"/>
                                <TextBlock Text="{Binding LoadedFilesCount}" 
                                           FontWeight="Bold" 
                                           Foreground="#0078D4"/>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <TextBlock Text="Total: " Foreground="#666666"/>
                                <TextBlock Text="{Binding TotalFilesCount}" FontWeight="Bold"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Cancel Button -->
                    <Button Content="Cancel Loading" 
                            Command="{Binding CancelLoadingCommand}"
                            HorizontalAlignment="Center"
                            Margin="0,20,0,0"
                            Padding="24,10"
                            Cursor="Hand">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Background" Value="#F0F0F0"/>
                                <Setter Property="Foreground" Value="#333333"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="BorderBrush" Value="#CCCCCC"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}"
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                    CornerRadius="6"
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#E0E0E0"/>
                                        <Setter Property="BorderBrush" Value="#999999"/>
                                    </Trigger>
                                    <Trigger Property="IsPressed" Value="True">
                                        <Setter Property="Background" Value="#D0D0D0"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- Hint Text -->
                    <TextBlock Text="Tip: You can continue working while files load in the background"
                               FontSize="11"
                               Foreground="#999999"
                               FontStyle="Italic"
                               HorizontalAlignment="Center"
                               Margin="0,16,0,0"
                               TextWrapping="Wrap"
                               TextAlignment="Center"/>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</Window>
